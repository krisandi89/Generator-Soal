<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Soal SD Dilaraf (Client Side + GitHub Integration)</title>
    <!-- Tailwind CSS untuk UI Generator -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js untuk baca PDF di browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Custom Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Preview JSON Styling */
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-800">

    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6 text-center border-t-4 border-blue-600">
            <h1 class="text-2xl font-bold text-slate-800">üõ†Ô∏è Generator Soal Ujian SD Dilaraf</h1>
            <p class="text-slate-500 text-sm mt-1">Generate & Auto-Push ke GitHub Pages</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Left Panel: Input Form -->
            <div class="md:col-span-1 space-y-4">
                
                <!-- API Key Config -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-blue-100">
                    <label class="block text-xs font-bold uppercase text-blue-600 mb-2">1. Konfigurasi AI</label>
                    <div class="mb-3">
                        <label class="block text-sm font-medium mb-1">Gemini API Key</label>
                        <input type="password" id="apiKey" class="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="AIzaSy...">
                    </div>
                </div>

                <!-- GitHub Config -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <label class="block text-xs font-bold uppercase text-gray-600 mb-2">2. Konfigurasi GitHub (Opsional)</label>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase">GitHub Username</label>
                            <input type="text" id="ghOwner" class="w-full p-2 border border-slate-300 rounded text-sm" placeholder="contoh: budi123">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase">Repository Name</label>
                            <input type="text" id="ghRepo" class="w-full p-2 border border-slate-300 rounded text-sm" placeholder="contoh: bank-soal-sd">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase">Personal Access Token (PAT)</label>
                            <input type="password" id="ghToken" class="w-full p-2 border border-slate-300 rounded text-sm" placeholder="ghp_xxxxx...">
                            <p class="text-[10px] text-red-400 mt-1">*Wajib centang scope 'repo' saat buat token</p>
                        </div>
                    </div>
                </div>

                <!-- Main Form -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-green-100">
                    <label class="block text-xs font-bold uppercase text-green-600 mb-2">3. Data Soal</label>
                    
                    <div class="mb-3">
                        <label class="block text-sm font-medium mb-1">Mata Pelajaran</label>
                        <select id="mapel" class="w-full p-2 border border-slate-300 rounded text-sm bg-white">
                            <option value="Pancasila">Pancasila</option>
                            <option value="IPAS">IPAS</option>
                            <option value="PAI">PAI</option>
                            <option value="Bahasa Arab">Bahasa Arab</option>
                            <option value="Budi Pekerti" selected>Budi Pekerti</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            <option value="Matematika">Matematika</option>
                            <option value="Bahasa Inggris">Bahasa Inggris</option>
                            <option value="Seni Rupa">Seni Rupa</option>
                            <option value="PJOK">PJOK</option>
                            <option value="TIK">TIK</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Upload Materi (PDF)</label>
                        <input type="file" id="pdfFile" accept="application/pdf" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>

                    <button onclick="startGeneration()" id="btnGenerate" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition shadow-lg mb-2">
                        <i class="fas fa-magic mr-2"></i> Generate Soal
                    </button>
                    
                    <div id="loader" class="loader mt-4"></div>
                    <p id="statusMsg" class="text-center text-xs text-slate-500 mt-2 italic"></p>
                </div>
            </div>

            <!-- Right Panel: Result & Preview -->
            <div class="md:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-sm min-h-[500px] flex flex-col">
                    <div class="flex justify-between items-center mb-4 border-b pb-4">
                        <h2 class="text-lg font-bold">Hasil Output</h2>
                        <div class="flex gap-2">
                            <button onclick="downloadHTML()" id="btnDownload" disabled class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition">
                                <i class="fas fa-download"></i> Download HTML
                            </button>
                            <button onclick="uploadToGitHub()" id="btnGithub" disabled class="px-3 py-1 bg-gray-800 text-white rounded text-sm hover:bg-gray-900 disabled:opacity-50 disabled:cursor-not-allowed transition">
                                <i class="fab fa-github"></i> Push to GitHub
                            </button>
                        </div>
                    </div>

                    <!-- GitHub Status Log -->
                    <div id="ghLog" class="hidden mb-4 p-3 bg-gray-50 border border-gray-200 rounded text-xs font-mono text-gray-600"></div>

                    <!-- Preview Area -->
                    <div id="previewArea" class="flex-grow bg-slate-50 rounded border border-slate-200 p-4 font-mono text-xs overflow-auto h-96">
                        <p class="text-slate-400 text-center mt-20">
                            Belum ada data. Silakan upload PDF dan klik Generate.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 1. CONFIGURATION & THEMES ---
        const THEMES = {
            "Pancasila": { primary: "#0984e3", secondary: "#74b9ff", bg: "#f0f8ff" },
            "IPAS": { primary: "#27ae60", secondary: "#2ecc71", bg: "#eafaf1" },
            "PAI": { primary: "#00b894", secondary: "#55efc4", bg: "#e8fff8" },
            "Bahasa Arab": { primary: "#d35400", secondary: "#e67e22", bg: "#fdf2e9", font: "@import url('https://fonts.googleapis.com/css2?family=Amiri&display=swap'); .arabic-text { font-family: 'Amiri', serif; font-size: 1.4em; }" },
            "Budi Pekerti": { primary: "#8e44ad", secondary: "#9b59b6", bg: "#f5eaf7" },
            "Bahasa Indonesia": { primary: "#c0392b", secondary: "#e74c3c", bg: "#fadbd8" },
            "Matematika": { primary: "#2980b9", secondary: "#3498db", bg: "#eaf2f8" },
            "Bahasa Inggris": { primary: "#e84393", secondary: "#fd79a8", bg: "#fce4ec" },
            "Seni Rupa": { primary: "#e67e22", secondary: "#f39c12", bg: "#fff3e0" },
            "PJOK": { primary: "#d35400", secondary: "#e67e22", bg: "#fff1e6" },
            "TIK": { primary: "#34495e", secondary: "#1abc9c", bg: "#ecf0f1" }
        };

        let generatedQuestions = null;
        let generatedHTML = null;

        // --- 2. PDF EXTRACTION (CLIENT SIDE) ---
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(" ");
                fullText += pageText + "\n";
            }
            return fullText.substring(0, 50000); 
        }

        // --- 3. PROMPT BUILDER ---
        function buildPrompt(mapel, textData) {
            return `
            Bertindaklah sebagai Guru SD Kelas 4 profesional. 
            Tugasmu adalah membuat SOAL UJIAN untuk mata pelajaran "${mapel}" berdasarkan materi teks berikut.

            --- MATERI ---
            ${textData.substring(0, 30000)} ...
            --- END MATERI ---

            Hasilkan output HANYA dalam format JSON Array (tanpa markdown code block).
            Total 40 Soal dengan urutan ID 1-40.

            DISTRIBUSI JENIS SOAL (WAJIB):
            1. ID 1-10: 'pg' (Pilihan Ganda Biasa) -> 4 opsi (A,B,C,D), answer angka 0-3.
            2. ID 11-20: 'pg_kompleks' (Pilihan Ganda Kompleks) -> answer array index [0, 2] (pilih 2 benar).
            3. ID 21-30: 'bs' (Benar Salah) -> answer string "Benar" atau "Salah".
            4. ID 31-35: 'isian' (Isian Singkat) -> answer string pendek.
            5. ID 36-40: 'uraian' (Uraian) -> answer string penjelasan.

            ATURAN KHUSUS KONTEN:
            - Jika Mapel 'Bahasa Indonesia' atau 'Bahasa Inggris': Buat minimal 3 soal yang punya bacaan. Masukkan bacaan di field 'text' menggunakan tag HTML: <div class='reading-text'>[Isi Bacaan]</div>.
            - Jika Mapel 'Bahasa Arab': Gunakan tag <span class='arabic-text'>[Teks Arab]</span> untuk tulisan Arab.
            - Setiap soal WAJIB punya field "hint" (1 kalimat petunjuk singkat).
            - Pastikan soal ORIGINAL (parafrase materi), bahasa mudah dimengerti anak kelas 4 SD.

            STRUKTUR OBJECT JSON:
            {
                "id": 1,
                "type": "pg",
                "text": "Pertanyaan...",
                "options": ["Opsi A", "Opsi B", "Opsi C", "Opsi D"],
                "answer": 0,
                "hint": "Petunjuk..."
            }
            `;
        }

        // --- 4. TEMPLATE BUILDER ---
        function generateExamHTML(mapel, questions) {
            const theme = THEMES[mapel] || THEMES["Budi Pekerti"];
            const extraCSS = theme.font || "";
            const questionsJSON = JSON.stringify(questions, null, 4);

            return `<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian ${mapel} Kelas 4 - SD Dilaraf Islamic School</title>
    <style>
        ${extraCSS}
        .reading-text { background: #fff; padding: 15px; border: 2px dashed #ccc; margin-bottom: 15px; border-radius: 10px; font-style: italic; line-height: 1.6; font-family: 'Times New Roman', serif; }
        :root {
            --primary: ${theme.primary};
            --secondary: ${theme.secondary};
            --bg-color: ${theme.bg};
            --card-bg: #ffffff;
            --text: #2d3436;
            --border: #dfe6e9;
            --success: #27ae60;
            --error: #c0392b;
            --warning: #f1c40f;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 20px; color: var(--text);
        }

        .container {
            max-width: 800px; margin: 0 auto; background: var(--card-bg);
            border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden;
        }

        .header {
            background: var(--primary); color: white; padding: 30px;
            text-align: center; border-bottom: 5px solid rgba(0,0,0,0.1);
        }
        .header h1 { margin: 0; font-size: 1.8em; }
        .header p { margin: 10px 0 0; opacity: 0.9; }

        .question-list { padding: 30px; }
        .question-item { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px dashed var(--border); }
        .q-number { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: block; }
        .q-text { font-size: 1.1em; margin-bottom: 15px; line-height: 1.5; }

        .options-group { display: flex; flex-direction: column; gap: 10px; }
        .radio-label, .checkbox-label {
            display: flex; align-items: center; padding: 10px 15px;
            background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .radio-label:hover, .checkbox-label:hover { background: #e8daef; border-color: var(--primary); }
        input[type="radio"], input[type="checkbox"] { margin-right: 12px; transform: scale(1.2); }

        .input-text, .input-area {
            width: 100%; padding: 12px; border: 2px solid #b2bec3; border-radius: 8px;
            font-family: inherit; font-size: 1em; box-sizing: border-box;
        }
        .input-area { min-height: 80px; resize: vertical; }
        .input-text:focus, .input-area:focus { outline: none; border-color: var(--primary); background: #f4ecf7; }

        .feedback-box { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; background-color: #f1f2f6; border-left: 5px solid #ccc; }
        .feedback-box.correct { background-color: #d4edda; border-left-color: var(--success); color: #155724; }
        .feedback-box.wrong { background-color: #f8d7da; border-left-color: var(--error); color: #721c24; }
        .feedback-box.manual { background-color: #fff3cd; border-left-color: #ffc107; color: #856404; }

        .answer-key { font-weight: bold; margin-top: 5px; display: block; }
        .explanation { font-size: 0.9em; margin-top: 5px; font-style: italic; }

        .footer-action {
            background: #f1f2f6; padding: 20px; text-align: center; border-top: 1px solid var(--border);
            position: sticky; bottom: 0; box-shadow: 0 -5px 10px rgba(0,0,0,0.05);
        }
        .btn-submit {
            background-color: var(--primary); color: white; border: none; padding: 15px 40px;
            font-size: 1.2em; border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        .btn-submit:hover { transform: scale(1.05); }

        .score-board {
            text-align: center; padding: 20px; background: var(--secondary); color: white;
            display: none; margin-bottom: 20px; border-radius: 0 0 15px 15px;
        }
        .back-btn { display: inline-block; margin-top: 10px; color: var(--bg-color); text-decoration: underline; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ù Ujian ${mapel}</h1>
            <p>Kelas 4 - SD Dilaraf Islamic School</p>
        </div>
        <div class="score-board" id="score-board">
            <h2>Hasil Pengerjaan</h2>
            <div style="font-size: 3em; font-weight: bold;" id="final-score">0</div>
            <p>Nilai di atas hanya untuk soal PG & Benar Salah.</p>
            <p>Silakan periksa Isian & Uraian secara mandiri.</p>
            <a href="index.html" class="back-btn">Kembali ke Menu Utama</a>
        </div>
        <div class="question-list" id="question-container"></div>
        <div class="footer-action" id="footer-action">
            <button class="btn-submit" onclick="submitExam()">Kumpulkan Jawaban ‚úÖ</button>
        </div>
    </div>
    <script>
        const questions = ${questionsJSON};
        const container = document.getElementById('question-container');

        function renderQuestions() {
            let html = "";
            questions.forEach((q, index) => {
                let inputHtml = "";
                let qNum = index + 1;
                if (q.type === 'pg' || q.type === 'bs') {
                    let options = q.type === 'bs' ? ["Benar", "Salah"] : q.options;
                    options.forEach((opt, i) => {
                        let val = q.type === 'bs' ? opt : i;
                        inputHtml += \`<label class="radio-label"><input type="radio" name="q\${q.id}" value="\${val}">\${q.type === 'pg' ? String.fromCharCode(65+i) + '. ' : ''} \${opt}</label>\`;
                    });
                } else if (q.type === 'pg_kompleks') {
                    q.options.forEach((opt, i) => {
                        inputHtml += \`<label class="checkbox-label"><input type="checkbox" name="q\${q.id}" value="\${i}">\${opt}</label>\`;
                    });
                } else if (q.type === 'isian') {
                    inputHtml = \`<input type="text" class="input-text" name="q\${q.id}" placeholder="Ketik jawabanmu..." autocomplete="off">\`;
                } else if (q.type === 'uraian') {
                    inputHtml = \`<textarea class="input-area" name="q\${q.id}" placeholder="Tulis jawaban lengkapmu..."></textarea>\`;
                }
                html += \`
                    <div class="question-item" id="q-block-\${q.id}">
                        <span class="q-number">Soal No. \${qNum}</span>
                        <div class="q-text">\${q.text}</div>
                        <div class="options-group">\${inputHtml}</div>
                        <div class="feedback-box" id="feedback-\${q.id}"></div>
                    </div>\`;
            });
            container.innerHTML = html;
        }

        function submitExam() {
            let score = 0; let maxScorePG = 0;
            questions.forEach(q => {
                const feedbackEl = document.getElementById(\`feedback-\${q.id}\`);
                let isCorrect = false; let userAnswer = "-";
                
                if (q.type === 'pg' || q.type === 'bs') {
                    maxScorePG++;
                    const selected = document.querySelector(\`input[name="q\${q.id}"]:checked\`);
                    if (selected) {
                        userAnswer = selected.value;
                        let valToCheck = q.type === 'pg' ? parseInt(userAnswer) : userAnswer;
                        if (valToCheck === q.answer) isCorrect = true;
                    }
                    if (isCorrect) {
                        score++; feedbackEl.className = "feedback-box correct"; feedbackEl.innerHTML = \`‚úÖ <b>Jawaban Benar!</b>\`;
                    } else {
                        feedbackEl.className = "feedback-box wrong";
                        let correctText = (q.type === 'pg') ? q.options[q.answer] : q.answer;
                        feedbackEl.innerHTML = \`‚ùå <b>Jawaban Kurang Tepat.</b><br><span class="answer-key">Kunci: \${correctText}</span><div class="explanation">Hint: \${q.hint}</div>\`;
                    }
                } else if (q.type === 'pg_kompleks') {
                    maxScorePG++;
                    const checkedBoxes = document.querySelectorAll(\`input[name="q\${q.id}"]:checked\`);
                    let userIndices = Array.from(checkedBoxes).map(cb => parseInt(cb.value)).sort();
                    let correctIndices = [...q.answer].sort();
                    if (JSON.stringify(userIndices) === JSON.stringify(correctIndices)) {
                        isCorrect = true; score++; feedbackEl.className = "feedback-box correct"; feedbackEl.innerHTML = \`‚úÖ <b>Jawaban Benar!</b>\`;
                    } else {
                        feedbackEl.className = "feedback-box wrong";
                        let correctText = q.answer.map(idx => "‚Ä¢ " + q.options[idx]).join("<br>");
                        feedbackEl.innerHTML = \`‚ùå <b>Jawaban Kurang Tepat.</b><br><span class="answer-key">Harusnya pilih:</span><br>\${correctText}<div class="explanation">Hint: \${q.hint}</div>\`;
                    }
                } else {
                    const input = document.querySelector(\`[name="q\${q.id}"]\`);
                    userAnswer = input ? input.value : "";
                    feedbackEl.className = "feedback-box manual";
                    feedbackEl.innerHTML = \`üìù <b>Periksa Mandiri</b><br>Jawaban Kamu: <b>\${userAnswer||"-"}</b><br><span class="answer-key">Kunci: \${q.answer}</span>\`;
                }
                feedbackEl.style.display = "block";
                const inputs = document.querySelectorAll(\`[name="q\${q.id}"]\`);
                inputs.forEach(inp => inp.disabled = true);
            });
            document.getElementById('final-score').textContent = maxScorePG > 0 ? Math.round((score/maxScorePG)*100) : 0;
            document.getElementById('score-board').style.display = "block";
            document.getElementById('footer-action').style.display = "none";
            window.scrollTo({top:0, behavior:'smooth'});
        }
        renderQuestions();
    <\/script>
</body>
</html>`;
        }

        // --- 5. MAIN LOGIC ---
        async function startGeneration() {
            const apiKey = document.getElementById('apiKey').value;
            const mapel = document.getElementById('mapel').value;
            const pdfFile = document.getElementById('pdfFile').files[0];
            const statusMsg = document.getElementById('statusMsg');
            const loader = document.getElementById('loader');
            const btn = document.getElementById('btnGenerate');
            const previewArea = document.getElementById('previewArea');
            const btnDownload = document.getElementById('btnDownload');
            const btnGithub = document.getElementById('btnGithub');

            // Reset States
            statusMsg.textContent = "";
            previewArea.innerHTML = "";
            btnDownload.disabled = true;
            btnGithub.disabled = true;

            // Validations
            if (!apiKey) return alert("Harap masukkan Gemini API Key!");
            if (!pdfFile) return alert("Harap upload file PDF materi!");

            try {
                // UI Loading
                btn.disabled = true;
                btn.classList.add('opacity-50');
                loader.style.display = 'block';
                statusMsg.textContent = "1/3 Membaca file PDF...";

                // 1. Read PDF
                const textData = await extractTextFromPDF(pdfFile);
                if (!textData || textData.trim().length < 50) throw new Error("Teks PDF terlalu sedikit atau kosong.");

                statusMsg.textContent = "2/3 Mengirim prompt ke Gemini AI...";

                // 2. Build Prompt & Call API
                const prompt = buildPrompt(mapel, textData);
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "Gagal menghubungi Gemini.");
                }

                const result = await response.json();
                const aiText = result.candidates[0].content.parts[0].text;

                statusMsg.textContent = "3/3 Memvalidasi JSON...";

                // 3. Clean & Parse JSON
                let jsonString = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                generatedQuestions = JSON.parse(jsonString);

                // 4. Validate Count
                if (!Array.isArray(generatedQuestions) || generatedQuestions.length < 35) {
                    throw new Error("AI gagal menghasilkan jumlah soal yang cukup. Coba lagi.");
                }

                // 5. Generate HTML File Content
                generatedHTML = generateExamHTML(mapel, generatedQuestions);

                // 6. Update UI
                previewArea.textContent = JSON.stringify(generatedQuestions, null, 2);
                btnDownload.disabled = false;
                
                // Enable GitHub button if config exists
                if(document.getElementById('ghOwner').value && document.getElementById('ghRepo').value && document.getElementById('ghToken').value) {
                    btnGithub.disabled = false;
                } else {
                    btnGithub.title = "Isi konfigurasi GitHub dulu";
                }

                statusMsg.textContent = "‚úÖ Selesai! Silakan download atau push ke GitHub.";

            } catch (error) {
                console.error(error);
                statusMsg.textContent = "‚ùå Error: " + error.message;
                alert("Terjadi kesalahan: " + error.message);
            } finally {
                loader.style.display = 'none';
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        // --- 6. GITHUB UPLOAD LOGIC ---
        async function uploadToGitHub() {
            const owner = document.getElementById('ghOwner').value;
            const repo = document.getElementById('ghRepo').value;
            const token = document.getElementById('ghToken').value;
            const mapel = document.getElementById('mapel').value;
            const ghLog = document.getElementById('ghLog');

            if (!owner || !repo || !token) {
                return alert("Harap lengkapi User, Repo, dan Token GitHub!");
            }

            const fileName = mapel.toLowerCase().replace(/\s+/g, '') + '.html';
            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`;

            ghLog.className = "block mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-xs font-mono text-blue-600";
            ghLog.textContent = `‚è≥ Menghubungkan ke GitHub: ${owner}/${repo}/${fileName}...`;

            try {
                // 1. Cek apakah file sudah ada (untuk dapat SHA)
                let sha = null;
                const getResponse = await fetch(apiUrl, {
                    headers: { 'Authorization': `token ${token}` }
                });

                if (getResponse.ok) {
                    const data = await getResponse.json();
                    sha = data.sha;
                    ghLog.textContent = `‚ÑπÔ∏è File ditemukan (SHA: ${sha.substring(0,7)}). Melakukan update...`;
                } else if (getResponse.status === 404) {
                    ghLog.textContent = `‚ÑπÔ∏è File belum ada. Membuat file baru...`;
                } else {
                    throw new Error(`Gagal cek file: ${getResponse.statusText}`);
                }

                // 2. Prepare Payload (Base64 Encode with UTF-8 support)
                // btoa alone fails with emojis/unicode, so we use this trick:
                const contentEncoded = btoa(unescape(encodeURIComponent(generatedHTML)));

                const payload = {
                    message: `Update soal ${mapel} via Generator`,
                    content: contentEncoded,
                    branch: "main" // Default branch
                };
                if (sha) payload.sha = sha;

                // 3. PUT Request
                const putResponse = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!putResponse.ok) {
                    const err = await putResponse.json();
                    throw new Error(err.message || "Gagal upload.");
                }

                ghLog.className = "block mb-4 p-3 bg-green-50 border border-green-200 rounded text-xs font-mono text-green-700";
                ghLog.innerHTML = `‚úÖ <b>SUKSES!</b> File berhasil di-push ke repository.<br><a href="https://github.com/${owner}/${repo}/blob/main/${fileName}" target="_blank" class="underline">Lihat di GitHub</a>`;

            } catch (error) {
                console.error(error);
                ghLog.className = "block mb-4 p-3 bg-red-50 border border-red-200 rounded text-xs font-mono text-red-700";
                ghLog.textContent = `‚ùå Error GitHub: ${error.message}`;
            }
        }

        // --- 7. UTILS ---
        function downloadHTML() {
            if (!generatedHTML) return;
            const mapelName = document.getElementById('mapel').value.toLowerCase().replace(/\s+/g, '');
            const blob = new Blob([generatedHTML], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${mapelName}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Enable GitHub button dynamically
        ['ghOwner', 'ghRepo', 'ghToken'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                const btnGithub = document.getElementById('btnGithub');
                const hasData = document.getElementById('ghOwner').value && 
                              document.getElementById('ghRepo').value && 
                              document.getElementById('ghToken').value;
                if(hasData && generatedHTML) btnGithub.disabled = false;
            });
        });
    </script>
</body>
</html>
